<!doctype>

<canvas width="500" height="500" style="background:black;"></canvas>
<script>
'use strict';

function drawDot(ctx, g, x, y, r) {
  ctx.save();
  ctx.translate(x - r, y - r )
  ctx.fillRect(0, 0, 2 * r, 2 * r);

  ctx.restore();
}

function main() {
  var canvas = document.querySelector('canvas');
  console.time('draw');
  var ctx = canvas.getContext('2d');
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, 500, 500);

  var r = 60;

  var gradient = ctx.createRadialGradient(r, r, r, r, r, 0);
  gradient.addColorStop(0, "transparent");
  // gradient.addColorStop(.2, "transparent");
  gradient.addColorStop(.8, 'rgba(255, 255, 255, 0.5)');
  gradient.addColorStop(1, 'rgba(255, 255, 255, 0.5)');
  ctx.fillStyle = gradient;

  for (var i = 0; i < 50; i++) {
    var x = 50 + Math.random() * 400;
    var y = 50 + Math.random() * 400;
    drawDot(ctx, gradient, x, y, r);
  }

  var imageData = ctx.getImageData(0, 0, 500, 500);
  imageData = changeColors(imageData);
  ctx.putImageData(imageData, 0, 0);
  console.timeEnd('draw');
}

function max(data) {
  var max = 0;
  for (var i = 0; i < data.length; i += 4) {
    if (data[i] > max) {
      max = data[i];
    }
  }
  return max
}

function changeColors(imageData) {
  var data = imageData.data;
  var f = 255 / max(data);
  for (var i = 0; i < data.length; i += 4) {
    var a = data[i];
    var rgba = getColor(a * f);
    for (var j = 0; j < 4; j++) {
      data[i + j] = rgba[j];
    }
  }
  return imageData;
}

// transparent-black -> green -> yellow -> red
function getColor(a) {
  var r = [0, 0, 0, 0];
  var N1 = 60, N2 = 140;
  if (a < 100) {
    // [0,0,0,0] -> [0, 255, 0, 255]
    r[1] = r[3] = a * 255 / N1;
    r[0] = r[2] = 0;
  } else if (a < N2) {
      // [0, 255, 0, 255] -> [255, 255, 0, 255]
      r[0] = (a - N1) / (N2 - N1) * 255;
      r[2] = 0;
      r[1] = r[3] = 255;
  } else {
    // [255, 255, 0, 255] -> [255, 0, 0, 255]
    r[0] = r[3] = 255;
    r[2] = 0;
    r[1] = 255 - (a - N2) / (255 - N2) * 255;
  }
  return r;
}

/**
 * Converts an HSL color value to RGB. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes h, s, and l are contained in the set [0, 1] and
 * returns r, g, and b in the set [0, 255].
 *
 * @param   Number  h       The hue
 * @param   Number  s       The saturation
 * @param   Number  l       The lightness
 * @return  Array           The RGB representation
 */
function hslToRgb(h, s, l){
    var r, g, b;

    if(s == 0){
        r = g = b = l; // achromatic
    }else{
        var hue2rgb = function hue2rgb(p, q, t){
            if(t < 0) t += 1;
            if(t > 1) t -= 1;
            if(t < 1/6) return p + (q - p) * 6 * t;
            if(t < 1/2) return q;
            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        }

        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        var p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
    }

    return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

main();

</script>
